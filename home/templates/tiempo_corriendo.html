<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temporizador Activo - {{ timer.categoria }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00d2ff;
            --secondary: #3a7bd5;
            --danger: #ff4757;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
        }

        /* --- 1. FONDO Y BASE --- */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0f0c29;
            background-image: radial-gradient(circle at center, #1a1a2e 0%, #0f0c29 100%);
            color: var(--text-main);
            overflow: hidden;
            position: relative;
        }

        /* --- 2. FONDO DE PART√çCULAS (Vida) --- */
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            z-index: 0;
            animation: floatUp linear infinite;
        }

        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            50% { opacity: 0.6; }
            100% { transform: translateY(-10vh) scale(1); opacity: 0; }
        }

        /* --- 3. OVERLAY DE PROGRESO DIN√ÅMICO --- */
        #progress-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%; 
            /* El color se definir√° din√°micamente en JS */
            background: linear-gradient(to top, var(--dynamic-color, #2ecc71), transparent);
            transition: height 1s linear, background 1s linear;
            z-index: 1;
            opacity: 0.4;
            pointer-events: none;
        }

        /* --- 4. CONTENIDO (GLASS CARD) --- */
        .container {
            z-index: 10;
            width: 100%;
            max-width: 550px;
            padding: 20px;
            perspective: 1000px;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 50px 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* --- ESTILO BOT√ìN NOTIFICACI√ìN (Nuevo) --- */
        .btn-notify {
            background: rgba(0, 210, 255, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
        }
        .btn-notify:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 15px var(--primary);
        }
        .btn-notify:disabled {
            border-color: #2ecc71;
            color: #2ecc71;
            background: transparent;
            cursor: default;
            box-shadow: none;
        }

        /* Categor√≠a y Duraci√≥n */
        h2 {
            margin: 0 0 10px 0;
            font-size: 1.4rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }
        
        .timer-info {
            color: var(--text-muted);
            font-size: 0.95rem;
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 20px;
        }

        /* --- TEMPORIZADOR GIGANTE --- */
        h1#timer {
            font-size: 5.5rem; /* Tama√±o base */
            font-weight: 700;
            margin: 10px 0;
            color: #fff;
            /* La sombra y el color cambiar√°n con JS */
            text-shadow: 0 0 20px var(--dynamic-glow, rgba(255,255,255,0.2));
            transition: all 0.5s ease-in-out; 
            font-variant-numeric: tabular-nums; /* Evita que los n√∫meros salten */
        }

        /* --- CLASES DE URGENCIA (Animaciones) --- */
        
        /* Crecimiento suave (< 10 min) */
        .urgency-medium {
            transform: scale(1.15); /* Crece un 15% */
            color: #ffca28 !important; /* Amarillo alerta */
        }

        /* Latido y p√°nico (< 1 min) */
        .urgency-high {
            transform: scale(1.2);
            color: #ff4757 !important; /* Rojo peligro */
            animation: heartbeat 1s infinite;
        }

        /* Desvanecimiento fantasma (√∫ltimos 10 seg) */
        .urgency-critical {
            animation: ghostFade 1s infinite alternate;
            color: #ff0000 !important;
            text-shadow: 0 0 30px red !important;
        }

        @keyframes heartbeat {
            0% { transform: scale(1.2); }
            50% { transform: scale(1.25); text-shadow: 0 0 40px red; }
            100% { transform: scale(1.2); }
        }

        @keyframes ghostFade {
            0% { opacity: 1; filter: blur(0px); }
            100% { opacity: 0.4; filter: blur(2px); }
        }

        /* Mensaje Final */
        .mensaje-finalizado {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            background: linear-gradient(45deg, #ff4757, #ff6b81);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Botones */
        .btn-group {
            margin-top: 40px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .btn-glass {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .btn-glass:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn-action {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            border: none;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

    </style>
</head>
<body>

    <div id="progress-overlay"></div>

    <div id="particles-container"></div>

    <div class="container">
        <div class="card">
            
            <button id="btn-permiso" class="btn-notify">üîî Activar notificaciones al terminar</button>

            <h2>{{ timer.categoria }}</h2>
            
            <div class="timer-info">
                Tiempo Total: <span id="duracion-total-txt">{{ timer.duracion }}</span>
            </div>

            <h1 id="timer">00:00:00</h1>
            
            <div id="mensaje-finalizado" class="mensaje-finalizado" style="display: none;">
                ¬°TIEMPO TERMINADO! <br> üöÄ
            </div>

            <div class="btn-group">
                <a class="btn-glass" href="{% url 'home' %}">
                    Men√∫ Principal
                </a>
                <a class="btn-glass btn-action" href="{% url 'vista_agregar_tiempo' %}">
                    + Nuevo Timer
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- 0. DECLARACI√ìN TEMPRANA DE INTERVALO (Fix ReferenceError) ---
            let intervalo = null;

            // --- 1. CONFIGURACI√ìN DE TIEMPO Y PARSEO ---
            // Leemos el tiempo restante que env√≠a Django
            let tiempoRestanteMs = parseInt('{{ tiempo_restante_ms|default:0 }}');
            if (isNaN(tiempoRestanteMs)) tiempoRestanteMs = 0;

            // TRUCO PARA PERSISTENCIA:
            // En lugar de asumir que el tiempo restante es el total, calculamos el total
            // parseando el texto "HH:MM:SS" que viene de {{ timer.duracion }}.
            function parseDurationStr(str) {
                // Formato esperado "HH:MM:SS" o "MM:SS"
                const parts = str.split(':').map(Number);
                let ms = 0;
                if (parts.length === 3) { // HH:MM:SS
                    ms = (parts[0] * 3600 + parts[1] * 60 + parts[2]) * 1000;
                } else if (parts.length === 2) { // MM:SS
                    ms = (parts[0] * 60 + parts[1]) * 1000;
                }
                return ms;
            }

            const duracionTxt = document.getElementById('duracion-total-txt').innerText.trim();
            let tiempoTotalMs = parseDurationStr(duracionTxt);

            // Fallback de seguridad: si el parseo falla o da 0, usamos el restante como total
            if (tiempoTotalMs <= 0) tiempoTotalMs = tiempoRestanteMs;

            // --- 2. ELEMENTOS DOM ---
            const timerDisplay = document.getElementById('timer');
            const overlay = document.getElementById('progress-overlay');
            const msgFinal = document.getElementById('mensaje-finalizado');
            const btnPermiso = document.getElementById('btn-permiso');

            // --- 3. L√ìGICA DE NOTIFICACIONES (INTEGRADA) ---
            
            // A. Pedir permiso al hacer click
            btnPermiso.addEventListener('click', () => {
                if (!("Notification" in window)) {
                    alert("Tu navegador no soporta notificaciones");
                } else {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            btnPermiso.textContent = "‚úÖ Notificaciones Activadas";
                            btnPermiso.disabled = true; // Desactivar bot√≥n para indicar √©xito
                            // Peque√±a vibraci√≥n de prueba
                            if (navigator.vibrate) navigator.vibrate(50);
                        }
                    });
                }
            });

            // B. Funci√≥n para disparar la alerta
            function lanzarNotificacion() {
                // 1. Vibrar (Celulares)
                if (navigator.vibrate) {
                    window.navigator.vibrate([200, 100, 200, 100, 500]);
                }
                // 2. Notificaci√≥n Visual (Escritorio/M√≥vil)
                if (Notification.permission === "granted") {
                    const notificacion = new Notification("¬°TIEMPO TERMINADO!", {
                        body: "El timer de {{ timer.categoria }} ha llegado a cero.",
                        icon: "https://cdn-icons-png.flaticon.com/512/850/850960.png"
                    });
                    notificacion.onclick = function() { window.focus(); };
                }
            }


            // --- 4. L√ìGICA DEL LOOP PRINCIPAL ---
            function actualizar() {
                if (tiempoRestanteMs <= 0) {
                    finalizar();
                    return;
                }

                // A. Formateo de texto
                const totalSeconds = Math.floor(tiempoRestanteMs / 1000);
                const h = Math.floor(totalSeconds / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = totalSeconds % 60;
                const fmt = n => String(n).padStart(2, '0');
                timerDisplay.innerText = `${fmt(h)}:${fmt(m)}:${fmt(s)}`;
                document.title = `${fmt(m)}:${fmt(s)} - Timer`;

                // B. C√°lculo de Progreso (Porcentaje completado)
                let porcentajeCompletado = 100;
                if (tiempoTotalMs > 0) {
                    porcentajeCompletado = ((tiempoTotalMs - tiempoRestanteMs) / tiempoTotalMs) * 100;
                }
                
                // Actualizar altura del fondo
                overlay.style.height = `${porcentajeCompletado}%`;

                // C. CAMBIO DE COLOR (Verde -> Amarillo -> Rojo)
                const hue = 120 - (porcentajeCompletado * 1.2); 
                const colorDin = `hsl(${hue}, 80%, 50%)`;
                
                // Aplicamos el color al overlay y al glow del texto
                document.documentElement.style.setProperty('--dynamic-color', colorDin);
                document.documentElement.style.setProperty('--dynamic-glow', colorDin);

                // D. EFECTOS DE URGENCIA (Clases CSS)
                timerDisplay.className = ''; // Limpiar clases previas

                // Menos de 10 minutos (600 seg) -> Crecer un poco
                if (totalSeconds < 600 && totalSeconds > 60) {
                    timerDisplay.classList.add('urgency-medium');
                }
                // Menos de 1 minuto -> Latido fuerte
                else if (totalSeconds <= 60 && totalSeconds > 10) {
                    timerDisplay.classList.add('urgency-high');
                }
                // Menos de 10 segundos -> Efecto Fantasma / Desvanecer
                else if (totalSeconds <= 10) {
                    timerDisplay.classList.add('urgency-critical');
                }

                // Reducir tiempo
                tiempoRestanteMs -= 1000;
            }

            function finalizar() {
                timerDisplay.style.display = 'none';
                msgFinal.style.display = 'block';
                
                // Estilo final de fondo
                overlay.style.height = '100%';
                overlay.style.background = 'var(--danger)';
                document.title = "¬°TIEMPO TERMINADO!";
                
                // Detener intervalo
                if (intervalo) clearInterval(intervalo);

                // üî• EJECUTAR NOTIFICACIONES
                lanzarNotificacion();
            }

            // Iniciar
            actualizar(); // Ejecutar una vez inmediato
            
            // Solo iniciamos el intervalo si a√∫n queda tiempo
            if (tiempoRestanteMs > 0) {
                intervalo = setInterval(actualizar, 1000);
            }

            // --- 5. SISTEMA DE PART√çCULAS (AMBIENTE VIVO) ---
            function createParticles() {
                const container = document.getElementById('particles-container');
                const particleCount = 20; // Cantidad de part√≠culas

                for (let i = 0; i < particleCount; i++) {
                    const p = document.createElement('div');
                    p.classList.add('particle');
                    
                    // Tama√±o aleatorio
                    const size = Math.random() * 5 + 2;
                    p.style.width = `${size}px`;
                    p.style.height = `${size}px`;
                    
                    // Posici√≥n horizontal aleatoria
                    p.style.left = `${Math.random() * 100}vw`;
                    
                    // Duraci√≥n de animaci√≥n aleatoria
                    p.style.animationDuration = `${Math.random() * 10 + 5}s`;
                    p.style.animationDelay = `${Math.random() * 5}s`;

                    container.appendChild(p);
                }
            }
            createParticles();
        });
    </script>
</body>
</html>